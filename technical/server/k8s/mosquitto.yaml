apiVersion: v1
kind: ConfigMap
metadata:
  name: mosquitto-config
  namespace: home-automation
data:
  mosquitto.conf: |
    # TLS-only listener for tenant traffic.
    listener 8883 0.0.0.0
    protocol mqtt

    cafile /mosquitto/certs/ca.crt
    certfile /mosquitto/certs/server.crt
    keyfile /mosquitto/certs/server.key
    tls_version tlsv1.2

    allow_anonymous false
    password_file /mosquitto/passwords/passwd
    acl_file /mosquitto/config/acl.conf

    # Keep each broker independent with local persistence.
    # No bridging is configured between broker pods.
    persistence true
    persistence_location /mosquitto/data/
    autosave_interval 1800
    autosave_on_changes false

    log_dest stdout
    log_type error
    log_type warning
    log_type notice
  acl.conf: |
    # Orchestrator/admin accounts can manage all tenant namespaces.
    user api
    topic readwrite tenants/+/devices/+/#
    user orchestrator
    topic readwrite tenants/+/devices/+/#

    # Tenant isolation model:
    # username == tenant_id, and each tenant is restricted to tenants/<tenant_id>/...
    # Device telemetry/events (publish):
    pattern write tenants/%u/devices/+/state
    pattern write tenants/%u/devices/+/event/+
    # Device command stream (subscribe):
    pattern read tenants/%u/devices/+/cmd/+
    # Optional tenant-side app channels:
    pattern readwrite tenants/%u/app/#
---
apiVersion: v1
kind: Service
metadata:
  name: mosquitto-brokers
  namespace: home-automation
spec:
  clusterIP: None
  selector:
    app: mosquitto
  ports:
    - name: mqtt
      port: 1883
      targetPort: 1883
    - name: mqtts
      port: 8883
      targetPort: 8883
---
apiVersion: v1
kind: Service
metadata:
  name: mosquitto
  namespace: home-automation
spec:
  type: NodePort
  selector:
    app: mosquitto
  ports:
    - name: mqtt
      port: 1883
      targetPort: 1883
      nodePort: 31883
    - name: mqtts
      port: 8883
      targetPort: 8883
      nodePort: 31884
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mosquitto
  namespace: home-automation
spec:
  serviceName: mosquitto-brokers
  replicas: 2
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app: mosquitto
  template:
    metadata:
      labels:
        app: mosquitto
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: mosquitto
                topologyKey: kubernetes.io/hostname
      securityContext:
        runAsUser: 1883
        runAsGroup: 1883
        fsGroup: 1883
      initContainers:
        - name: prepare-mosquitto-files
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              set -eu
              cp /input-config/mosquitto.conf /mosquitto/config/mosquitto.conf
              cp /input-config/acl.conf /mosquitto/config/acl.conf
              cp /input-passwords/passwd /mosquitto/passwords/passwd
              chown 1883:1883 /mosquitto/config/mosquitto.conf /mosquitto/config/acl.conf /mosquitto/passwords/passwd
              chmod 0700 /mosquitto/config/acl.conf /mosquitto/passwords/passwd
          volumeMounts:
            - name: mosquitto-config-source
              mountPath: /input-config
              readOnly: true
            - name: mosquitto-passwords-source
              mountPath: /input-passwords
              readOnly: true
            - name: mosquitto-config-runtime
              mountPath: /mosquitto/config
            - name: mosquitto-passwords-runtime
              mountPath: /mosquitto/passwords
      containers:
        - name: mosquitto
          image: eclipse-mosquitto:2.0
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 1883
              name: mqtt
            - containerPort: 8883
              name: mqtts
          volumeMounts:
            - name: mosquitto-config-runtime
              mountPath: /mosquitto/config/mosquitto.conf
              subPath: mosquitto.conf
              readOnly: true
            - name: mosquitto-config-runtime
              mountPath: /mosquitto/config/acl.conf
              subPath: acl.conf
              readOnly: true
            - name: mosquitto-certs
              mountPath: /mosquitto/certs/ca.crt
              subPath: ca.crt
              readOnly: true
            - name: mosquitto-certs
              mountPath: /mosquitto/certs/server.crt
              subPath: server.crt
              readOnly: true
            - name: mosquitto-certs
              mountPath: /mosquitto/certs/server.key
              subPath: server.key
              readOnly: true
            - name: mosquitto-passwords-runtime
              mountPath: /mosquitto/passwords/passwd
              subPath: passwd
              readOnly: true
            - name: mosquitto-data
              mountPath: /mosquitto/data
            - name: mosquitto-log
              mountPath: /mosquitto/log
          startupProbe:
            exec:
              command:
                - sh
                - -c
                - '[ "$(cat /proc/1/comm)" = "mosquitto" ]'
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 30
          readinessProbe:
            exec:
              command:
                - sh
                - -c
                - '[ "$(cat /proc/1/comm)" = "mosquitto" ]'
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - '[ "$(cat /proc/1/comm)" = "mosquitto" ]'
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
      volumes:
        - name: mosquitto-config-source
          configMap:
            name: mosquitto-config
            defaultMode: 0440
        - name: mosquitto-config-runtime
          emptyDir: {}
        - name: mosquitto-certs
          secret:
            secretName: mosquitto-certs
            defaultMode: 0440
        - name: mosquitto-passwords-source
          secret:
            secretName: mosquitto-passwords
            defaultMode: 0440
        - name: mosquitto-passwords-runtime
          emptyDir: {}
  volumeClaimTemplates:
    - metadata:
        name: mosquitto-data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 2Gi
    - metadata:
        name: mosquitto-log
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
